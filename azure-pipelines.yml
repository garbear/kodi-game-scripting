################################################################################
#
# Pipeline to process Kodi game -addons
#
################################################################################

#
# Parameters:
#
#   Secret files:
#     * privateKey - the SSH private key used to push to kodi-game repos
#
#   Git authorship:
#     * TODO: Parameterize git authorship
#

# TODO: Run as a cron job
trigger:
- master

jobs:
  - job: Build

    pool: 'Default'

    strategy:
        matrix:
          Python38:
            python.version: '3.8'

    timeoutInMinutes: 0 # Use the maximum limit

    steps:
    - script: |
        dpkg -s libasound2-dev || sudo apt-get install -y libasound2-dev # Required by mame
        dpkg -s libpcap-dev || sudo apt-get install -y libpcap-dev # Required by desmume
        #dpkg -s libsdl2-dev || sudo apt-get install -y libsdl2-dev # Required by dosbox-core
        dpkg -s mesa-common-dev || sudo apt-get install -y mesa-common-dev # Required by craft, desmume, flycast, parallel_n64 and mupen64plus-nx
        dpkg -s libgl1-mesa-dev || sudo apt-get install -y libgl1-mesa-dev # Required by craft, openlara, parallel_n64 on ubuntu-18.04
        dpkg -s nasm || sudo apt-get install -y nasm # Required by mupen64plus-nx and parallext
        #dpkg -s ninja-build || sudo apt-get install -y ninja-build # Required by dosbox-core
      displayName: 'Install system dependencies'

    # TODO: git authorship
    - script: |
        git config --global user.name "Garrett Brown"
        git config --global user.email "themagnificentmrb@gmail.com"
      displayName: 'Set Git authorship'

    - script: |
        git clone --branch retroplayer-19alpha1 --depth=1 https://github.com/kodi-game/xbmc.git kodi
      displayName: 'Clone Kodi'

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(python.version)

    - script: |
        pip install -r requirements.txt
        #pip3 install meson # Required by dosbox-core
      displayName: 'Install Python requirements'

    - template: azure-process-addon.yml
      parameters:
        # List add-ons in reverse order for sorted results in the kodi-game org
        addons:
          - yabause
